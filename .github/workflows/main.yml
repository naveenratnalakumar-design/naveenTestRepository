name: Apex Automated Tests

on:
  workflow_dispatch:
  # schedule:
  #   # Run every day at 8:00 AM UTC
  #   - cron: '0 8 * * *'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci   # safer than npm install for CI

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: |
          npx playwright test ./tests/dashboardAndTaskListValidation.spec.js \
            --trace=on \
            --reporter=json > playwright-report.json

      - name: Generate Test Summary Table
        if: always()
        run: |
          echo "## Playwright Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Case Name | Status | Duration (sec) |" >> $GITHUB_STEP_SUMMARY
          echo "| -------------- | ------ | -------------- |" >> $GITHUB_STEP_SUMMARY
          node <<'EOF' >> $GITHUB_STEP_SUMMARY
          const fs = require('fs');

          if (!fs.existsSync('playwright-report.json')) {
            console.log('| No report found | ‚ùå | 0 |');
            process.exit(0);
          }

          const report = JSON.parse(fs.readFileSync('playwright-report.json', 'utf8'));

          function capitalize(word = 'unknown') {
            return word.charAt(0).toUpperCase() + word.slice(1);
          }

          function walkSuites(suites = []) {
            for (const suite of suites) {
              if (suite.specs) {
                for (const spec of suite.specs) {
                  for (const test of spec.tests || []) {
                    const result = test.results?.[0];
                    const status = capitalize(result?.status);
                    const duration = result
                      ? (result.duration / 1000).toFixed(2)
                      : '0.00';

                    console.log(`| ${spec.title} | ${status} | ${duration} |`);
                  }
                }
              }
              if (suite.suites) {
                walkSuites(suite.suites);
              }
            }
          }

          walkSuites(report.suites);
          EOF

      - name: Upload Playwright HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
